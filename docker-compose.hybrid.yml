# ===========================================
# Trackfy - Docker Compose HIBRIDO
# Servicios locales + BD Amenazas de PRODUCCION
# ===========================================
#
# Solo requiere tÃºnel SSH al puerto 5432 (PostgreSQL amenazas)
# El resto de servicios corren localmente
#
# USO: Ver ENTORNO-HIBRIDO.txt para instrucciones
#
# ===========================================

services:
  # -----------------------------------------
  # API Gateway - LOCAL
  # -----------------------------------------
  api-gateway:
    build:
      context: ./api-gateway
      dockerfile: Dockerfile
    container_name: api-gateway
    ports:
      - "8080:8080"
    environment:
      - PORT=8080
      - DATABASE_URL=postgres://trackfy:trackfy_secret@postgres-gateway:5432/trackfy_gateway?sslmode=disable
      - REDIS_URL=redis:6379
      - REDIS_PASSWORD=
      - REDIS_DB=1
      - JWT_SECRET=${JWT_SECRET:-your-super-secret-jwt-key-change-in-production}
      - JWT_ACCESS_TTL=15m
      - JWT_REFRESH_TTL=168h
      - FY_ENGINE_URL=http://fy-engine:8082
      - FY_ENGINE_TIMEOUT=30s
      - FY_ANALYSIS_URL=http://fy-analysis:9090
      - FY_ANALYSIS_TIMEOUT=30s
    restart: unless-stopped
    networks:
      - trackfy-network
    depends_on:
      postgres-gateway:
        condition: service_healthy
      redis:
        condition: service_healthy
      fy-engine:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # -----------------------------------------
  # Fy-Engine - LOCAL
  # -----------------------------------------
  fy-engine:
    build:
      context: ./fy-engine/fy-engine
      dockerfile: Dockerfile
    container_name: fy-engine
    ports:
      - "8082:8082"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - ANALYSIS_SERVICE_URL=http://fy-analysis:9090
    restart: unless-stopped
    networks:
      - trackfy-network
    depends_on:
      - redis
      - fy-analysis
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8082/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # -----------------------------------------
  # Fy-Analysis - LOCAL pero conecta a BD PRODUCCION
  # -----------------------------------------
  fy-analysis:
    build:
      context: ./fy-analysis
      dockerfile: Dockerfile
    container_name: fy-analysis
    ports:
      - "9090:9090"
    environment:
      - PORT=9090
      - ENVIRONMENT=development
      - LOG_LEVEL=debug
      - RATE_LIMIT=100
      - GOOGLE_WEBRISK_KEY=${GOOGLE_WEBRISK_KEY:-}
      - URLSCAN_KEY=${URLSCAN_KEY:-}
      # >>> APUNTA A BD DE PRODUCCION via port forward <<<
      - DATABASE_URL=postgres://trackfy:trackfy_secret@host.docker.internal:5432/fy_threats?sslmode=disable
      - ENABLE_LOCAL_DB=true
    restart: unless-stopped
    networks:
      - trackfy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # -----------------------------------------
  # Fy-DBSync - LOCAL pero conecta a BD PRODUCCION
  # -----------------------------------------
  fy-dbsync:
    build:
      context: ./fy-dbsync
      dockerfile: Dockerfile
    container_name: fy-dbsync
    ports:
      - "9091:9091"
    environment:
      - PORT=9091
      - ENVIRONMENT=development
      - LOG_LEVEL=info
      # >>> APUNTA A BD DE PRODUCCION via port forward <<<
      - DATABASE_URL=postgres://trackfy:trackfy_secret@host.docker.internal:5432/fy_threats?sslmode=disable
      - PHISHTANK_KEY=${PHISHTANK_KEY:-}
      - URLHAUS_INTERVAL=5m
      - PHISHTANK_INTERVAL=1h
    restart: unless-stopped
    networks:
      - trackfy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

  # -----------------------------------------
  # Fy-Admin - LOCAL pero conecta a BD PRODUCCION
  # -----------------------------------------
  fy-admin:
    build:
      context: ./fy-admin
      dockerfile: Dockerfile
    container_name: fy-admin
    ports:
      - "9092:9092"
    environment:
      - PORT=9092
      # >>> APUNTA A BD DE PRODUCCION via port forward <<<
      - DATABASE_URL=postgres://trackfy:trackfy_secret@host.docker.internal:5432/fy_threats?sslmode=disable
      - DBSYNC_URL=http://fy-dbsync:9091
      - ANALYSIS_URL=http://fy-analysis:9090
    restart: unless-stopped
    networks:
      - trackfy-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    depends_on:
      fy-dbsync:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9092/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # -----------------------------------------
  # PostgreSQL Gateway - LOCAL (usuarios)
  # -----------------------------------------
  postgres-gateway:
    image: postgres:16-alpine
    container_name: fy-postgres-gateway
    ports:
      - "5433:5432"
    environment:
      - POSTGRES_USER=trackfy
      - POSTGRES_PASSWORD=trackfy_secret
      - POSTGRES_DB=trackfy_gateway
    volumes:
      - postgres-gateway-data:/var/lib/postgresql/data
      - ./api-gateway/scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql:ro
    restart: unless-stopped
    networks:
      - trackfy-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U trackfy -d trackfy_gateway"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # -----------------------------------------
  # Redis - LOCAL
  # -----------------------------------------
  redis:
    image: redis:7-alpine
    container_name: fy-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - trackfy-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3

# -----------------------------------------
# Volumes (solo los locales)
# -----------------------------------------
volumes:
  postgres-gateway-data:
    name: fy-postgres-gateway-data
  redis-data:
    name: fy-redis-data

# -----------------------------------------
# Networks
# -----------------------------------------
networks:
  trackfy-network:
    driver: bridge
    name: trackfy-network
