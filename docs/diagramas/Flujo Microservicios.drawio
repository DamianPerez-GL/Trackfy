<mxfile host="app.diagrams.net" agent="Claude" version="22.1.0">
  <diagram name="Flujo Mensajes" id="flujo-mensajes">
    <mxGraphModel dx="1200" dy="900" grid="1" gridSize="10" guides="1" tooltips="1" connect="1" arrows="1" fold="1" page="1" pageScale="1" pageWidth="1200" pageHeight="1100" math="0" shadow="0">
      <root>
        <mxCell id="0" />
        <mxCell id="1" parent="0" />

        <!-- Titulo -->
        <mxCell id="title" value="Diagrama de Secuencia - Flujo de Mensaje Trackfy" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=16;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="350" y="10" width="400" height="30" as="geometry" />
        </mxCell>

        <!-- Participantes -->
        <mxCell id="app" value="App Flutter" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#dae8fc;strokeColor=#6c8ebf;" vertex="1" parent="1">
          <mxGeometry y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="app_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="100" as="sourcePoint" />
            <mxPoint x="50" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="gateway" value="API Gateway&#xa;:8080 (Go)" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#fff2cc;strokeColor=#d6b656;" vertex="1" parent="1">
          <mxGeometry x="200" y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="gateway_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="250" y="100" as="sourcePoint" />
            <mxPoint x="250" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="engine" value="Fy-Engine&#xa;:8082 (Python)" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#d5e8d4;strokeColor=#82b366;" vertex="1" parent="1">
          <mxGeometry x="400" y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="engine_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="100" as="sourcePoint" />
            <mxPoint x="450" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="analysis" value="Fy-Analysis&#xa;:9090 (Go)" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#ffe6cc;strokeColor=#d79b00;" vertex="1" parent="1">
          <mxGeometry x="600" y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="analysis_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="650" y="100" as="sourcePoint" />
            <mxPoint x="650" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="llm" value="OpenAI API&#xa;(GPT)" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#e1d5e7;strokeColor=#9673a6;" vertex="1" parent="1">
          <mxGeometry x="800" y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="llm_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="850" y="100" as="sourcePoint" />
            <mxPoint x="850" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <mxCell id="db" value="PostgreSQL&#xa;Threats :5432" style="rounded=0;whiteSpace=wrap;html=1;fontStyle=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="1000" y="60" width="100" height="40" as="geometry" />
        </mxCell>
        <mxCell id="db_line" style="endArrow=none;dashed=1;html=1;dashPattern=1 3;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1050" y="100" as="sourcePoint" />
            <mxPoint x="1050" y="950" as="targetPoint" />
          </mxGeometry>
        </mxCell>

        <!-- Flujo 1: App -> Gateway -->
        <mxCell id="arrow1" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="50" y="140" as="sourcePoint" />
            <mxPoint x="250" y="140" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label1" value="1. POST /chat/message (JWT + mensaje)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="60" y="120" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 2: Gateway -> Engine -->
        <mxCell id="arrow2" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="250" y="170" as="sourcePoint" />
            <mxPoint x="450" y="170" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label2" value="2. HTTP POST /process (user_id, mensaje)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="260" y="150" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- Activacion Engine -->
        <mxCell id="engine_act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;" vertex="1" parent="1">
          <mxGeometry x="445" y="175" width="10" height="50" as="geometry" />
        </mxCell>
        <mxCell id="engine_note" value="3. Clasificar intencion&#xa;   - Regex: URL, email, telefono&#xa;   - Detectar tipo de consulta" style="text;html=1;strokeColor=#000000;fillColor=#ffffff;align=left;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="465" y="175" width="170" height="50" as="geometry" />
        </mxCell>

        <!-- Box ALT -->
        <mxCell id="alt_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#000000;dashed=0;" vertex="1" parent="1">
          <mxGeometry x="20" y="240" width="1090" height="400" as="geometry" />
        </mxCell>
        <mxCell id="alt_label" value="alt" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="25" y="243" width="30" height="20" as="geometry" />
        </mxCell>
        <mxCell id="alt_cond1" value="[Contiene URL / Email / Telefono - Requiere analisis]" style="text;html=1;strokeColor=none;fillColor=#e0e0e0;align=left;verticalAlign=middle;rounded=0;fontSize=10;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="60" y="243" width="300" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 4: Engine -> Analysis -->
        <mxCell id="arrow4" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="280" as="sourcePoint" />
            <mxPoint x="650" y="280" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label4" value="4. HTTP POST /analyze&#xa;{type: url|email|phone, value, context}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="478" y="251" width="180" height="30" as="geometry" />
        </mxCell>

        <!-- Activacion Analysis -->
        <mxCell id="analysis_act" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#000000;" vertex="1" parent="1">
          <mxGeometry x="645" y="285" width="10" height="140" as="geometry" />
        </mxCell>
        <mxCell id="analysis_note" value="5. Pipeline de analisis:&#xa;   - Normalizar entrada&#xa;   - Consultar cache Redis&#xa;   - Query threat_domains&#xa;   - Query threat_emails&#xa;   - Query threat_phones (NUEVO)&#xa;   - Correlacion heuristica&#xa;   - Calcular score (0-100)" style="text;html=1;strokeColor=#000000;fillColor=#ffffff;align=left;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="665" y="285" width="180" height="120" as="geometry" />
        </mxCell>

        <!-- Flujo 5b: Analysis -> DB -->
        <mxCell id="arrow5b" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="650" y="320" as="sourcePoint" />
            <mxPoint x="1050" y="320" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label5b" value="5a. SELECT FROM threat_domains/emails/phones" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="780" y="300" width="250" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 5c: DB -> Analysis -->
        <mxCell id="arrow5c" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;strokeColor=#666666;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="1050" y="370" as="sourcePoint" />
            <mxPoint x="650" y="370" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label5c" value="5b. Resultados (matches, severity, source)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="780" y="350" width="250" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 6: Analysis -> Engine -->
        <mxCell id="arrow6" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="650" y="440" as="sourcePoint" />
            <mxPoint x="450" y="440" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label6" value="6. ThreatResult {score, level, threats[], reasons[]}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="465" y="420" width="200" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 7: Engine -> LLM -->
        <mxCell id="arrow7" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="480" as="sourcePoint" />
            <mxPoint x="850" y="480" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label7" value="7. Generar respuesta empatica con resultado de analisis" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="520" y="460" width="280" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 8: LLM -> Engine -->
        <mxCell id="arrow8" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="850" y="520" as="sourcePoint" />
            <mxPoint x="450" y="520" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label8" value="8. Respuesta Fy: 'Cuidado! Este enlace/telefono...'" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="540" y="500" width="250" height="20" as="geometry" />
        </mxCell>

        <!-- Linea separadora -->
        <mxCell id="sep_line" style="endArrow=none;dashed=1;html=1;dashPattern=8 8;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="20" y="550" as="sourcePoint" />
            <mxPoint x="1110" y="550" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="alt_cond2" value="[Mensaje normal - No requiere analisis]" style="text;html=1;strokeColor=none;fillColor=#e0e0e0;align=left;verticalAlign=middle;rounded=0;fontSize=10;fontStyle=2" vertex="1" parent="1">
          <mxGeometry x="60" y="555" width="220" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 9: Engine -> LLM (sin analisis) -->
        <mxCell id="arrow9" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="590" as="sourcePoint" />
            <mxPoint x="850" y="590" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label9" value="9. Generar respuesta conversacional (sin analisis)" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="530" y="570" width="260" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 10: LLM -> Engine -->
        <mxCell id="arrow10" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="850" y="620" as="sourcePoint" />
            <mxPoint x="450" y="620" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label10" value="10. Respuesta Fy conversacional" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="570" y="600" width="180" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 11: Engine -> Gateway -->
        <mxCell id="arrow11" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="450" y="700" as="sourcePoint" />
            <mxPoint x="250" y="700" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label11" value="11. {response, analysis?, fy_mood}" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="270" y="680" width="180" height="20" as="geometry" />
        </mxCell>

        <!-- Flujo 12: Gateway -> App -->
        <mxCell id="arrow12" style="html=1;verticalAlign=bottom;endArrow=block;edgeStyle=elbowEdgeStyle;elbow=vertical;curved=0;rounded=0;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="250" y="740" as="sourcePoint" />
            <mxPoint x="50" y="740" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="label12" value="12. 200 OK - JSON Response" style="text;html=1;strokeColor=none;fillColor=none;align=center;verticalAlign=middle;rounded=0;fontSize=10" vertex="1" parent="1">
          <mxGeometry x="80" y="720" width="160" height="20" as="geometry" />
        </mxCell>

        <!-- Notas -->
        <mxCell id="notes_box" value="Notas:&#xa;- Comunicacion entre microservicios: HTTP REST&#xa;- Clasificacion por Regex en Fy-Engine&#xa;- Fy-Analysis solo se invoca si hay URL/Email/Telefono&#xa;- LLM siempre genera la respuesta final con personalidad Fy&#xa;- threat_phones consulta Lista Hu (~21K numeros ES/LATAM)" style="text;html=1;strokeColor=#000000;fillColor=#ffffff;align=left;verticalAlign=top;rounded=0;fontSize=10;spacingLeft=5;spacingTop=5" vertex="1" parent="1">
          <mxGeometry x="20" y="780" width="380" height="100" as="geometry" />
        </mxCell>

        <!-- Leyenda -->
        <mxCell id="legend_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=none;strokeColor=#000000;" vertex="1" parent="1">
          <mxGeometry x="420" y="780" width="250" height="100" as="geometry" />
        </mxCell>
        <mxCell id="legend_title" value="Leyenda" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="430" y="785" width="50" height="15" as="geometry" />
        </mxCell>
        <mxCell id="legend1_line" style="endArrow=block;html=1;strokeWidth=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="430" y="815" as="sourcePoint" />
            <mxPoint x="490" y="815" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend1_text" value="Request sincrono" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="500" y="807" width="90" height="15" as="geometry" />
        </mxCell>
        <mxCell id="legend2_line" style="endArrow=block;html=1;strokeWidth=1;dashed=1;" edge="1" parent="1">
          <mxGeometry relative="1" as="geometry">
            <mxPoint x="430" y="840" as="sourcePoint" />
            <mxPoint x="490" y="840" as="targetPoint" />
          </mxGeometry>
        </mxCell>
        <mxCell id="legend2_text" value="Response" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="500" y="832" width="90" height="15" as="geometry" />
        </mxCell>
        <mxCell id="legend3_text" value="alt = Flujo condicional" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=9" vertex="1" parent="1">
          <mxGeometry x="430" y="860" width="120" height="15" as="geometry" />
        </mxCell>

        <!-- Tablas de amenazas -->
        <mxCell id="tables_box" value="" style="rounded=0;whiteSpace=wrap;html=1;fillColor=#f5f5f5;strokeColor=#666666;" vertex="1" parent="1">
          <mxGeometry x="700" y="780" width="280" height="100" as="geometry" />
        </mxCell>
        <mxCell id="tables_title" value="Tablas de Amenazas (PostgreSQL)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=middle;rounded=0;fontSize=10;fontStyle=1" vertex="1" parent="1">
          <mxGeometry x="710" y="785" width="200" height="15" as="geometry" />
        </mxCell>
        <mxCell id="tables_list" value="- threat_domains (URLhaus, OpenPhish)&#xa;- threat_emails (StopForumSpam)&#xa;- threat_phones (Lista Hu - NUEVO)&#xa;- whitelist_domains (Manual)" style="text;html=1;strokeColor=none;fillColor=none;align=left;verticalAlign=top;rounded=0;fontSize=9;spacingTop=5;spacingLeft=5" vertex="1" parent="1">
          <mxGeometry x="710" y="805" width="250" height="70" as="geometry" />
        </mxCell>

      </root>
    </mxGraphModel>
  </diagram>
</mxfile>
